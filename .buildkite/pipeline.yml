steps:
  - label: "ğŸ”„ Checkout"
    command: |
      echo "CÃ³digo descargado correctamente"
      ls -la

  - label: "ğŸ“¦ Setup + Tests Backend"
    id: "backend"
    plugins:
      - docker#v5.11.0:
          image: "php:8.2-cli"
          always-pull: false
          command:
            - /bin/bash
            - -lc
            - |
              echo "Instalando dependencias PHP..."
              cp .env.example .env
              php -v
              curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
              composer install --no-interaction --no-progress
              echo "âœ… Dependencias PHP instaladas"
              echo "Ejecutando tests PHPUnit..."
              php artisan test
              echo "âœ… Tests backend completados"

  - label: "ğŸ“¦ Setup + Tests Frontend"
    id: "frontend"
    plugins:
      - docker#v5.11.0:
          image: "node:18"
          always-pull: false
          command:
            - /bin/bash
            - -lc
            - |
              echo "Instalando dependencias Node..."
              node -v
              npm -v
              npm install
              echo "âœ… Dependencias Node instaladas"
              echo "Ejecutando tests Jest..."
              npm test
              echo "âœ… Tests frontend completados"

  - label: "ğŸ—ï¸ Build"
    depends_on:
      - "backend"
      - "frontend"
    command: |
      echo "Creando artefactos..."
      mkdir -p build
      tar -czf build/app.tar.gz app public resources tests composer.json package.json phpunit.xml .env.example
      echo "âœ… Build completado (build/app.tar.gz)"
    artifacts:
      - "build/app.tar.gz"

  - label: "ğŸš€ Deploy Staging"
    command: |
      echo "Desplegando a staging (simulado)..."
      sleep 3
      echo "âœ… Deploy exitoso"
    if: build.branch == "main"

timeout_in_minutes: 15
