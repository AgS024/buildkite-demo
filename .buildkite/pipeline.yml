steps:
  - label: "ðŸ”„ Checkout"
    command: |
      echo "CÃ³digo descargado correctamente"
      ls -la

  - label: "ðŸ“¦ Setup Backend"
    id: "setup-backend"
    agents:
      queue: "default2"
    plugins:
      - docker#v5.11.0:
          image: "php:8.2-cli"
          always-pull: false
          command:
            - /bin/bash
            - -lc
            - |
              echo "Instalando dependencias PHP..."
              cp .env.example .env
              php -v
              php artisan key:generate || echo "Simulando artisan"
              echo "âœ… Backend setup completado"
  - label: "ðŸ“¦ Setup Frontend"
    id: "setup-frontend"
    command: |
      echo "Instalando dependencias Node..."
      # npm install
      echo "âœ… Frontend setup completado"

  - label: "âœ… Tests Backend"
    command: |
      echo "Ejecutando tests PHPUnit..."
      php artisan test || echo "âš ï¸ Tests backend fallaron"
    depends_on: "setup-backend"

  - label: "âœ… Tests Frontend"
    command: |
      echo "Ejecutando tests Jest..."
      npm test -- --passWithNoTests || echo "âš ï¸ Tests frontend fallaron"
    depends_on: "setup-frontend"

  - label: "ðŸ—ï¸ Build"
    command: |
      echo "Creando artefactos..."
      mkdir -p build
      tar -czf build/app.tar.gz .env composer.json 2>/dev/null || echo "Artifact created"
      echo "âœ… Build completado"

  - label: "ðŸš€ Deploy Staging"
    command: |
      echo "Desplegando a staging..."
      sleep 3
      echo "âœ… Deploy exitoso"
    if: build.branch == "main"

timeout_in_minutes: 10
