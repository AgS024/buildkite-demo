steps:
  - label: "ğŸ”„ Checkout"
    command: |
      echo "CÃ³digo descargado correctamente"
      ls -la

  - label: "ğŸ“¦ Setup + Tests Backend"
    id: "backend"
    plugins:
      - docker#v5.11.0:
          image: "php:8.2-cli"
          always-pull: false
          command:
            - /bin/bash
            - -lc
            - |
              echo "Instalando dependencias PHP..."
              cp .env.example .env
              php -v
              curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
              composer install --no-interaction --no-progress
              echo "âœ… Dependencias PHP instaladas"
              echo "Ejecutando tests PHPUnit..."
              php artisan test
              echo "âœ… Tests backend completados"

  - label: "ğŸ“¦ Setup + Tests Frontend"
    id: "frontend"
    plugins:
      - docker#v5.11.0:
          image: "node:18"
          always-pull: false
          command:
            - /bin/bash
            - -lc
            - |
              echo "Instalando dependencias Node..."
              node -v
              npm -v
              npm install
              echo "âœ… Dependencias Node instaladas"
              echo "Ejecutando tests Jest..."
              npm test
              echo "âœ… Tests frontend completados"

  - label: "ğŸ—ï¸ Build"
    depends_on:
      - "backend"
      - "frontend"
    command: |
      echo "Creando artefactos..."
      mkdir -p build

      # Creamos una lista de paths que existan
      FILES=""
      for path in public app builds composer.json package.json .env; do
        if [ -e "$path" ]; then
          FILES="$FILES $path"
        else
          echo "Aviso: $path no existe, se omite del artefacto"
        fi
      done

      if [ -z "$FILES" ]; then
        echo "âš ï¸ No hay archivos para empaquetar, creando artefacto vacÃ­o"
        touch build/empty.txt
        tar -czf build/app.tar.gz build/empty.txt
      else
        echo "Empaquetando:$FILES"
        tar -czf build/app.tar.gz $FILES
      fi

      echo "âœ… Build completado (build/app.tar.gz)"


  - label: "ğŸš€ Deploy Staging"
    command: |
      echo "Desplegando a staging (simulado)..."
      sleep 3
      echo "âœ… Deploy exitoso"
    if: build.branch == "main"

timeout_in_minutes: 15
